version: '3.8'

services:
  # Backend Service (Python AI Model)
  model-service:
    build:
      context: ../model-service           # Path to the model-service folder
      dockerfile: Dockerfile
      target: production                  # F10
    container_name: sms-checker-model-service
    restart: unless-stopped

    # Port inside the container is controlled by MODEL_PORT (default 8081)
    environment:
      - MODEL_PORT=8081

    # Host port 8081 -> container port 8081
    ports:
      - "8081:8081"

    # Optional: persist trained models outside the container
    # Make sure the right-hand side matches where your code reads from (`output/`)
    volumes:
      - ../model-service/output:/model-service/output

  # Frontend Service (Spring Boot App)
  app:
    build:
      context: ../app                     # Path to the app folder
      dockerfile: Dockerfile
      args:
        GITHUB_ACTOR: ${GITHUB_ACTOR}
        GITHUB_TOKEN: ${GITHUB_TOKEN}
    container_name: sms-checker-app
    restart: unless-stopped

    # APP_PORT controls Spring Boot's server.port, MODEL_HOST points to the backend
    environment:
      - APP_PORT=8080
      - MODEL_HOST=http://model-service:8081

    # Host port 8080 -> container port 8080
    ports:
      - "8080:8080"

    # Ensure the app waits for the backend container to be created
    depends_on:
      - model-service
