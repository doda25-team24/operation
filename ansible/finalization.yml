- hosts: all
  become: yes
  tasks:

  # Run with: 
  # ansible-playbook -u vagrant --private-key=../.vagrant/machines/ctrl/virtualbox/private_key -i 192.168.56.100, finalization.yml
  
  - name: Ensure .kube directory exists
    file:
      path: /home/vagrant/.kube
      state: directory
      owner: vagrant
      group: vagrant
      mode: '0755'

  - name: Copy kubeconfig from cluster's admin.conf
    become: yes
    copy:
      remote_src: yes
      src: /etc/kubernetes/admin.conf
      dest: /home/vagrant/.kube/config
      owner: vagrant
      group: vagrant
      mode: 0600


  # Step: Install MetalLB
  - name: Install MetalLB
    command: >
      kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml
    environment:
      KUBECONFIG: /home/vagrant/.kube/config
        
  - name: Wait for MetalLB controller to be ready
    command: >
      kubectl wait -n metallb-system -l app=metallb,component=controller
      --for=condition=ready pod --timeout=60s
    environment:
      KUBECONFIG: /home/vagrant/.kube/config
    retries: 3
    delay: 10
    register: metallb_wait
    until: metallb_wait.rc == 0

  # Step: Configure MetalLB IPAddressPool
  - name: Create MetalLB IPAddressPool
    copy:
      dest: /tmp/metallb-pool.yaml
      content: |
        apiVersion: metallb.io/v1beta1
        kind: IPAddressPool
        metadata:
          name: default-pool
          namespace: metallb-system
        spec:
          addresses:
          - 192.168.56.99-192.168.56.199

  - name: Apply IPAddressPool
    command: kubectl apply -f /tmp/metallb-pool.yaml
    environment:
      KUBECONFIG: /home/vagrant/.kube/config


  # Step: Configure L2Advertisement
  - name: Create L2Advertisement
    copy:
      dest: /tmp/metallb-l2.yaml
      content: |
        apiVersion: metallb.io/v1beta1
        kind: L2Advertisement
        metadata:
          name: l2config
          namespace: metallb-system
        spec:
          ipAddressPools:
          - default-pool

  - name: Apply L2Advertisement
    command: kubectl apply -f /tmp/metallb-l2.yaml
    environment:
      KUBECONFIG: /home/vagrant/.kube/config

  # Step 21: Install ingress controller
  - name: Add ingress-nginx Helm repo
    become: false
    command: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
    ignore_errors: yes

  - name: Update helm repos
    become: false
    command: helm repo update

  - name: Install ingress-nginx
    become: false
    command: >
      helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx
      --namespace ingress-nginx --create-namespace
      --set controller.service.loadBalancerIP=192.168.56.110

  # Step 22: Install Kubernetes Dashboard
  - name: Wait for ingress-nginx controller to be ready
    command: >
      kubectl wait -n ingress-nginx
      --for=condition=ready pod
      --timeout=180s
      -l app.kubernetes.io/component=controller
    environment:
      KUBECONFIG: /home/vagrant/.kube/config
    retries: 3
    delay: 10
    register: ingress_wait
    until: ingress_wait.rc == 0

  - name: Add kubernetes-dashboard Helm repo
    become: false
    command: helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
    ignore_errors: yes

  - name: Update helm repos (again)
    become: false
    command: helm repo update

  - name: Install/upgrade kubernetes-dashboard
    become: false
    command: >
      helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
      --namespace kubernetes-dashboard --create-namespace

  - name: Wait for dashboard pods to be ready
    command: >
      kubectl wait -n kubernetes-dashboard
      --for=condition=ready pod
      --timeout=180s
      -l app.kubernetes.io/part-of=kubernetes-dashboard
    environment:
      KUBECONFIG: /home/vagrant/.kube/config
    retries: 3
    delay: 10
    register: dash_wait
    until: dash_wait.rc == 0

  # Step: Create admin-user (ServiceAccount + ClusterRoleBinding)
  - name: Create dashboard admin-user manifest
    copy:
      dest: /tmp/dashboard-admin-user.yaml
      content: |
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: admin-user
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: kubernetes-dashboard

  - name: Apply dashboard admin-user RBAC
    command: kubectl apply -f /tmp/dashboard-admin-user.yaml
    environment:
      KUBECONFIG: /home/vagrant/.kube/config

  # Step: Expose dashboard with Ingress (dashboard.local)
  - name: Create dashboard ingress manifest
    copy:
      dest: /tmp/dashboard-ingress.yaml
      content: |
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: kubernetes-dashboard
          namespace: kubernetes-dashboard
          annotations:
            nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        spec:
          ingressClassName: nginx
          rules:
          - host: dashboard.local
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: kubernetes-dashboard-kong-proxy
                    port:
                      number: 443

  - name: Apply dashboard ingress
    command: kubectl apply -f /tmp/dashboard-ingress.yaml
    environment:
      KUBECONFIG: /home/vagrant/.kube/config

  - name: Create dashboard cert directory
    file:
      path: /tmp/dashboard_certs
      state: directory
      mode: '0700'

  - name: Generate self-signed dashboard certificate
    command: >
      openssl req -newkey rsa:2048 -nodes -keyout /tmp/dashboard_certs/dashboard.key
      -x509 -days 365 -out /tmp/dashboard_certs/dashboard.crt
      -subj "/CN=kubernetes-dashboard"
    args:
      creates: /tmp/dashboard_certs/dashboard.crt  # Skips if file already exists

  - name: Create Kubernetes dashboard secret
    shell: >
      kubectl create secret generic kubernetes-dashboard-certs 
      --from-file=/tmp/dashboard_certs/dashboard.key 
      --from-file=/tmp/dashboard_certs/dashboard.crt 
      -n kubernetes-dashboard
    ignore_errors: yes  # Ignore if secret already exists


  - name: Patch dashboard ingress to enable TLS
    command: >
      kubectl -n kubernetes-dashboard patch ingress kubernetes-dashboard --type merge -p
      '{"spec":{"tls":[{"hosts":["dashboard.local"],"secretName":"dashboard-tls"}]}}'
    environment:
      KUBECONFIG: /home/vagrant/.kube/config

  # Step 23: Install istio
  - name: Detect VM architecture
    command: uname -m
    register: arch

  - name: Set Istio arch name
    set_fact:
      istio_arch: "{{ 'arm64' if arch.stdout in ['aarch64', 'arm64'] else 'amd64' }}"

  - name: Download Istio 1.25.2 (correct arch)
    get_url:
      url: "https://github.com/istio/istio/releases/download/1.25.2/istio-1.25.2-linux-{{ istio_arch }}.tar.gz"
      dest: /tmp/istio-1.25.2.tar.gz

  - name: Unpack Istio
    unarchive:
      src: /tmp/istio-1.25.2.tar.gz
      dest: /home/vagrant/
      remote_src: yes

  - name: Add istioctl to PATH
    lineinfile:
      path: /home/vagrant/.bashrc
      line: 'export PATH=/home/vagrant/istio-1.25.2/bin:$PATH'
      create: yes

  # Step: Create IstioOperator custom config
  - name: Create IstioOperator configuration for loadBalancerIP
    copy:
      dest: /tmp/istio-operator.yaml
      content: |
        apiVersion: install.istio.io/v1alpha1
        kind: IstioOperator
        metadata:
          name: istio-control-plane
          namespace: istio-system
        spec:
          profile: default
          components:
            ingressGateways:
              - name: istio-ingressgateway
                enabled: true
                k8s:
                  serviceAnnotations:
                    metallb.universe.tf/address-pool: default-pool
                  service:
                    type: LoadBalancer
                    loadBalancerIP: 192.168.56.120

  # Step: Install Istio using the operator file
  - name: Install Istio with custom IstioOperator
    command: >
      /home/vagrant/istio-1.25.2/bin/istioctl install -y -f /tmp/istio-operator.yaml
    environment:
      KUBECONFIG: /home/vagrant/.kube/config

  # Step: Wait for Istio ingress gateway to be ready
  - name: Wait for Istio ingressgateway to be ready
    command: >
      kubectl wait -n istio-system -l app=istio-ingressgateway
      --for=condition=ready pod --timeout=120s
    environment:
      KUBECONFIG: /home/vagrant/.kube/config
    retries: 5
    delay: 15
    register: istio_wait
    until: istio_wait.rc == 0
